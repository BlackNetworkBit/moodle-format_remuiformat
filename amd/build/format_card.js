define(["jquery","core/ajax","format_remuiformat/jquery.dragsort"],function(t,e){return{init:function(){function i(t){var e=t.changedTouches[0],i=document.createEvent("MouseEvent");i.initMouseEvent({touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup"}[t.type],!0,!0,window,1,e.screenX,e.screenY,e.clientX,e.clientY,!1,!1,!1,!1,0,null),e.target.dispatchEvent(i),t.preventDefault()}t(document).ready(function(){t("a.wdm-drag-drop").each(function(t,e){var o=e;o.addEventListener("touchstart",i,!0),o.addEventListener("touchmove",i,!0),o.addEventListener("touchend",i,!0),o.addEventListener("touchcancel",i,!0)})});var o=function(t){if(t.length>0){var e,i=[];t.css("min-height","initial"),t.each(function(t,o){e=(e=o.offsetHeight)>200?e:200,i.push(e)}),e=Math.max.apply(null,i)+55,t.css("min-height",e)}};function n(t){var e,i,o=decodeURIComponent(window.location.search.substring(1)).split("&");for(i=0;i<o.length;i++)if((e=o[i].split("="))[0]===t)return void 0===e[1]||e[1]}t(window).resize(function(){o(t(".single-card.wdm-col"))}),t("form.togglecompletion button").on("click",function(){var e=t(this).closest("form").find('input[name="id"]').val();e&&("Completed"==t(".wdm-completion-status-"+e).text().trim()?(t(".wdm-completion-status-"+e).html(M.util.get_string("markcomplete","format_remuiformat")),t(".activity-check-"+e).removeClass("completed")):(t(".wdm-completion-status-"+e).html(M.util.get_string("completed","format_remuiformat")),t(".activity-check-"+e).addClass("completed")),t(this).closest(".wdm-completion-container").toggleClass("text-muted"))}),t(".form.togglecompletion").submit(function(t){t.preventDefault()}),o(t(".single-card")),t("#page-course-view-remuiformat span.section-modchooser-link").addClass("btn btn-primary"),t(".single-card").css({opacity:0,visibility:"visible"}).animate({opacity:1},600,"swing"),t(".wdm-section-wrapper").dragsort({dragSelector:"a.wdm-drag-drop",dragBetween:!0,dragEnd:function(){var i=t(this).data("section"),o=n("id"),a=t(".wdm-section-wrapper li").map(function(){return t(this).data("id")}).get().toString();e.call([{methodname:"format_remuiformat_move_activities",args:{courseid:o,sectionid:i,sequence:a}}])[0].done(function(t){})},placeHolderTemplate:"<li class='placeHolder' style='border:1px solid gray;'></li>"}),M.course=M.course||{},M.course.format=M.course.format||{},M.course.format.get_config=function(){return{container_node:"div",container_class:"cards",section_node:"div",section_class:"section"}},M.course.format.swap_sections=function(t,e,i){var o="course-content",n="section_add_menus",a=t.Node.all("."+o+" "+M.course.format.get_section_selector(t));a.item(e).one("."+n).swap(a.item(i).one("."+n))},M.course.format.process_sections=function(t,e,i,o,n){var a="sectionname",s=".left .section-handle .icon";if("move"==i.action){if(o>n){var c=n;n=o,o=c}for(var r,d,l,m,u=o;u<=n;u++){var f=t.Node.create("<span>"+i.sectiontitles[u]+"</span>");e.item(u).all("."+a).setHTML(f),l=(d=(r=e.item(u).one(s)).getAttribute("alt")).lastIndexOf(" "),m=d.substr(0,l+1)+u,r.setAttribute("alt",m),r.setAttribute("title",m)}}},t(".wdm-section-wrapper .single-card-container .wdm-activity-actions .wdm-show-in-row").on("click",function(){var i=n("id"),o=t(this).data("wdmsectionid"),a=t(this).data("wdmactivityid"),s=t(this);e.call([{methodname:"format_remuiformat_show_activity_in_row",args:{courseid:i,sectionid:o,activityid:a}}])[0].done(function(e){"row"==e.type?(t(s).closest(".single-card-container").removeClass("col-lg-4 col-md-6 col-sm-12").addClass("col-12"),t(s).closest(".single-card-container .single-card").removeClass("wdm-col").addClass("wdm-min-row"),t(s).find(".wdmactivitytype").toggle()):(t(s).closest(".single-card-container").removeClass("col-12").addClass("col-lg-4 col-md-6 col-sm-12"),t(s).closest(".single-card-container .single-card").removeClass("wdm-min-row").addClass("wdm-col"),t(s).find(".wdmactivitytype").toggle())})}),t(".wdm-section-wrapper .single-card-container .wdm-activity-actions .ecfsectionname").on("click",function(){var i=n("id"),o=t(this).data("oldsectionid"),a=t(this).data("sectionidtomove"),s=t(this).closest(".single-card-container").attr("data-id"),c=t(this);e.call([{methodname:"format_remuiformat_move_activity_to_section",args:{courseid:i,newsectionid:a,oldsectionid:o,activityidtomove:s}}])[0].done(function(e){1==e.success?t(c).closest(".single-card-container").fadeOut("slow"):t('<div class="wdmactivityerrormsg alert alert-danger mt-10">'+e.message+"</div>").insertAfter(t(c).closest(".single-card-container .wdm-activity-actions"))})})}}});